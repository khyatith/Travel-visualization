<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <style>
        .country {
            fill: #ccc;
            stroke: #fff;
            stroke-width: .5px;
            stroke-linejoin: round;
        }
        
        .graticule {
            fill: none;
            stroke: #000;
            stroke-opacity: .3;
            stroke-width: .5px;
        }
        
        .graticule.outline {
            stroke: #333;
            stroke-opacity: 1;
            stroke-width: 1.5px;
        }
        
        #nRadius-value {
            font-size: 40px;
        }
        
        .button,
        .button:visited {
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            box-shadow: 1px 2px 4px 0 rgba(0, 0, 0, 0.6);
            text-shadow: 0 -1px 1px rgba(0, 0, 0, 0.25);
            border-bottom: 1px solid rgba(0, 0, 0, 0.25);
            border-right: 1px solid rgba(0, 0, 0, 0.25);
            position: relative;
            cursor: pointer;
            font-family: Calibri, Arial;
            margin-left: 4px;
            font-size: 16px;
            padding: 1px 8px 3px 8px;
        }
        
        .button:active {
            top: 1px;
            left: 1px;
        }
        
        .gray.button,
        .gray.button:visited {
            background-color: #CCCCCC;
            box-shadow: inset 1px 1px 2px 0 rgba(255, 255, 255, 0.6), inset -1px -1px 1px 0 rgba(100, 120, 140, 0.6), 1px 2px 4px 0 rgba(0, 0, 0, 0.6);
            color: #333;
            border-left: 1px solid #999;
            border-top: 1px solid #999;
            text-shadow: none;
        }
        
        .gray.button:hover {
            background-color: #999;
            color: #111;
        }
        
        div.tooltip {
            position: absolute;
            text-align: center;
            width: 150px;
            height: 130px;
            padding: 2px;
            font-size: 15px;
            background: white;
            border: 1px;
            border-radius: 4px;
            pointer-events: none;
            color: #000;
        }
        
        #USImport {
            fill: lightsteelblue;
        }
        
        #USExport {
            fill: lightsteelblue;
        }
        
        #CountryGDP {
            fill: lightsteelblue;
        }
        
        #mainButton {
            margin-left: 30%;
        }
        
        input[type=range] {
            /*removes default webkit styles*/
            /*
           -webkit-appearance: none;
*/
            /*fix for FF unable to apply focus style bug */
            
            border: 1px solid white;
            /*required for proper track sizing in FF*/
            
            width: 500px;
            margin-left: 10%;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 300px;
            height: 5px;
            background: #ddd;
            border: none;
            border-radius: 3px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: goldenrod;
            margin-top: -4px;
        }
        
        input[type=range]:focus {
            outline: none;
        }
        
        input[type=range]:focus::-webkit-slider-runnable-track {
            background: #ccc;
        }
        
        input[type=range]::-moz-range-track {
            width: 500px;
            height: 5px;
            background: #ddd;
            border: none;
            border-radius: 3px;
        }
        
        input[type=range]::-moz-range-thumb {
            border: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: goldenrod;
        }
        /*hide the outline behind the border*/
        
        input[type=range]:-moz-focusring {
            outline: 1px solid white;
            outline-offset: -1px;
        }
        
        input[type=range]::-ms-track {
            width: 300px;
            height: 5px;
            /*remove bg colour from the track, we'll use ms-fill-lower and ms-fill-upper instead */
            
            background: transparent;
            /*leave room for the larger thumb to overflow with a transparent border */
            
            border-color: transparent;
            border-width: 6px 0;
            /*remove default tick marks*/
            
            color: transparent;
        }
        
        input[type=range]::-ms-fill-lower {
            background: #777;
            border-radius: 10px;
        }
        
        input[type=range]::-ms-fill-upper {
            background: #ddd;
            border-radius: 10px;
        }
        
        input[type=range]::-ms-thumb {
            border: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: goldenrod;
        }
        
        input[type=range]:focus::-ms-fill-lower {
            background: #888;
        }
        
        input[type=range]:focus::-ms-fill-upper {
            background: #ccc;
        }
        
        .donut {
			margin-top:-25%;
            float: right;
        }
    </style>
</head>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <h1 align="center">U.S. Tourism Visualisation</h1>
    <h5 align="center">*"Import" shows information for people travel to U.S. <br/>
*"Export" shows information for U.S. citizens travel to the world. <br/>
*%ofGDP shows tourism contributes to GDP.<br/> *population data represents hundred thousand </h5>
    <svg style="float:right" width="350" height="150">
        <rect x="50" y="0" width="300" height="150" style="fill:rgb(255,255,255);stroke-width:3;stroke:rgb(0,0,0)" />
        <svg style="float:right" width="320" height="150">
            <image xlink:href="resources/images/vacation.png" x="200" y="10" height="25px" width="25px" />
            <text x="230" y="30">Vacation</text>
            <image xlink:href="resources/images/visit_friends.png" x="200" y="40" height="25px" width="25px" />
            <text x="230" y="60">Visit friends</text>
            <image xlink:href="resources/images/business.png" x="200" y="70" height="25px" width="25px" />
            <text x="230" y="90">Business</text>
            <image xlink:href="resources/images/education.png" x="200" y="100" height="25px" width="25px" />
            <text x="230" y="120">Education</text>
        </svg>
        <svg width="200" height="150" id="legendSvg">
        </svg>
        </rect>
    </svg>
    <input type="range" min="2006" max="2013" step="1" id="nRadius" list=volsettings>
    <datalist id=volsettings>
        <option>2006</option>
        <option>2007</option>
        <option>2008</option>
        <option>2009</option>
        <option>2010</option>
        <option>2011</option>
        <option>2012</option>
        <option>2013</option>
    </datalist>
    <label for="nRadius" style="display: inline-block; width: 100px; text-align: right">
        <span id="nRadius-value">â€¦</span>
    </label>

    <div id="mainButton">
        <button class="button gray" id="USImport">USImport</button>
        </li>
        <button class="button gray" id="USExport">USExport</button>
        <input type="button" value="%ofGDP" id="CountryGDP" class="button gray">
    </div>
    <script>
        var width = 780,
            height = 460;
        var ls_w = 20,
            ls_h = 20;
        var legendheight = 150;
        var projection = d3.geo.naturalEarth()
            .translate([400, 300])
            .scale(167)
            .precision(.1);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            //.style("border","1px solid #ccc")
        ;

        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var flag = {

            "vacation": 'resources/images/vacation.png',

            "visit_friends": 'resources/images/visit_friends.png',

            "business": 'resources/images/business.png',

            "education": 'resources/images/education.png',

            "unknown": ''
        }

        queue()
            .defer(d3.json, "world-50m.json")
            .defer(d3.json, "final_json.json")
            .await(ready);
        $("#USImport").on("click", function () {
            $("#USImport").css("fill", "lightskyblue");
            $("#USImport").css("stroke", "black");
            $("#USImport").css("stroke-width", "1");
            queue()
                .defer(d3.json, "world-50m.json")
                .defer(d3.json, "final_json.json")
                .await(ready);
        });

        function createPie(population, vacation, visit_friends, business, education) {

            var dataset = [
                {
                    "label": 'Vacation',
                    count: vacation
                },
                {
                    "label": 'Visit Friends',
                    count: visit_friends
                },
                {
                    "label": 'Business',
                    count: business
                },
                {
                    "label": 'Education',
                    count: education
                }
  ];

            var margin = {
                top: 40,
                right: 10,
                bottom: 40,
                left: 10
            };
            var width = 300 - margin.left - margin.right;
            var height = 300 - margin.top - margin.bottom;
            var radius = Math.min(width, height) / 2;
            var donutWidth = 30; // NEW
            var color = d3.scale.category10();
            var legendRectSize = 18;
            var legendSpacing = 4;
            var labelr = radius + 30;

            var svgpie = d3.select("body")
                .append("svg")
				.data([dataset])
                .attr('class', 'donut')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', 'translate(' + (width / 2) +
                    ',' + (height / 2) + ')');
            var arc = d3.svg.arc()
                .innerRadius(radius - donutWidth) // NEW
                .outerRadius(radius);

            var pie = d3.layout.pie()
                .value(function (d) {
                    return d.count;
                })
                .sort(null);

            var path = svgpie.selectAll('g.arc')
                .data(pie(dataset))
                .enter()
                .append('g')
                .attr('class', 'arc');
			
			path.append("path")
            .attr("fill", function(d, i) { return color(d.data.label);})
            .attr("d", arc)
            .transition()
      		  .ease("exp")
      		  .duration(1000)
      		  .attrTween("d",tweenPie);
			 
			path.append("text")
			.transition()
			.duration(1000)
			.attrTween("d",tweenPie)
            .attr("transform",function(d){
              return "translate("+arc.centroid(d)+")";
            })
			.text(function(d,i){
              return d.value + "%";
            })
			.attr("text-anchor", "middle")
            .attr("fill","#000000");

            var pielegend = svgpie.selectAll(".pielegend")
                .data(color.domain())
                .enter()
                .append("g")
                .attr("class", "pielegend")
                .attr("transform", function (d, i) {
                    var height = legendRectSize + legendSpacing;
                    var offset = height * color.domain().length / 2;
                    var horz = -3 * legendRectSize;
                    var vert = i * height - offset;
                    return "translate (" + horz + " , " + vert + ")";
                });
            pielegend.append("rect")
                .attr("width", legendRectSize)
                .attr("height", legendRectSize)
                .attr("fill", color)
                .attr("stroke", color);

            pielegend.append("text")
                .attr("x", legendRectSize + legendSpacing)
                .attr("y", legendRectSize - legendSpacing)
                .text(function (d) {
                    return d;
                });

            function tweenPie(b) {
                var i = d3.interpolate({
                    startAngle: 1.1 * Math.PI,
                    endAngle: 1.1 * Math.PI
                }, b);
                return function (t) {
                    return arc(i(t));
                };
            }
        }

        function ready(error, world, final) {

            var avg = (d3.min(final, function (d) {
                return d.y2006.population
            }) + d3.max(final, function (d) {
                return d.y2006.population
            })) / 2;
            var avg2 = (d3.min(final, function (d) {
                return d.y2006.population
            }) + d3.max(final, function (d) {
                return d.y2006.population
            })) / 3;
            var avg3 = (d3.min(final, function (d) {
                return d.y2006.population
            }) + d3.max(final, function (d) {
                return d.y2006.population
            })) / 4;
            var avg4 = (d3.min(final, function (d) {
                return d.y2006.population
            }) + d3.max(final, function (d) {
                return d.y2006.population
            })) / 6;
            var ext_color_domain = [d3.min(final, function (d) {
                return d.y2006.population;
            }), avg4, avg3, avg2, avg, d3.max(final, function (d) {
                return d.y2006.population
            })];
            var legend_labels = ["lowest", "", "", "", "", "highest"];
            var color = d3.scale.linear()
                .domain([d3.min(final, function (d) {
                    return d.y2006.population;
                }), avg, d3.max(final, function (d) {
                    return d.y2006.population
                })])
                .range(["#0ca454", "#ffa07a", "#de1f2e"])
                .clamp(true)
                .interpolate(d3.interpolateHcl);

            var treatiesById = d3.nest()
                .key(function (d) {
                    return d.id;
                })
                .sortValues(function (a, b) {
                    return a.y2006.population - b.y2006.population;
                })
                .map(final, d3.map);

            var country = svg.insert("g", ".graticule")
                .attr("class", "country")
                .selectAll("path")
                .data(topojson.feature(world, world.objects.countries).features)
                .enter().append("path")
                .attr("d", path);

            country.filter(function (d) {
                    return treatiesById.has(d.id);
                })
                .style("fill", function (d) {
                    return color(treatiesById.get(d.id)[0].y2006.population);
                });

            svg.selectAll("image")
                .data(final)
                .enter()
                .append("image")
                .attr("class", "purpose")
                .attr("xlink:href", function (d) {
                    var purpose_percentage = [["vacation", d.y2006.vacation], ["visit_friends", d.y2006.visit_friends], ["business", d.y2006.business], ["education", d.y2006.education]];
                    purpose_percentage.sort(function (a, b) {
                        return b[1] - a[1]
                    });
                    if (purpose_percentage[0][1] != null)
                        return flag[purpose_percentage[0][0]];
                    else return flag['unknown'];
                })
                .attr("x", function (d) {
                    return projection([d.lon, d.lat])[0] - 11;
                })
                .attr("y", function (d) {
                    return projection([d.lon, d.lat])[1] - 30;
                })
                .attr("width", "30")
                .attr("height", "30")
                .on("mouseover", function (d) {
                    createPie(d.y2006.population, d.y2006.vacation, d.y2006.visit_friends, d.y2006.business, d.y2006.education);

                })
                .on("mouseout", function () {
                    d3.selectAll('.donut').remove();
                });
            d3.select("#nRadius-value").text("2006");
            d3.select("#nRadius").property("value", "2006");


            d3.select("#nRadius").on("input", function () {
                updatevis(final, +this.value);
            });
            var legendSvg = d3.select("#legendSvg");

            var legend = legendSvg.selectAll("g.legend")
                .data(ext_color_domain)
                .enter().append("g")
                .attr("class", "legend");

            legend.append("rect")
                .attr("x", 70)
                .attr("y", function (d, i) {
                    return legendheight - (i * ls_h) - 2 * ls_h;
                })
                .attr("width", ls_w)
                .attr("height", ls_h)
                .style("fill", function (d, i) {
                    return color(d);
                })
                .style("opacity", 0.8);

            legend.append("text")
                .attr("x", 100)
                .attr("y", function (d, i) {
                    return legendheight - (i * ls_h) - ls_h - 4;
                })
                .text(function (d, i) {
                    return legend_labels[i];
                });

            function updatevis(data, year) {
                country.filter(function (d) {
                        return treatiesById.has(d.id);
                    })
                    .style("fill", function (d) {
                        switch (year) {
                        case 2006:
                            return color(treatiesById.get(d.id)[0].y2006.population);
                            break;
                        case 2007:
                            return color(treatiesById.get(d.id)[0].y2007.population);
                            break;
                        case 2008:
                            return color(treatiesById.get(d.id)[0].y2008.population);
                            break;
                        case 2009:
                            return color(treatiesById.get(d.id)[0].y2009.population);
                            break;
                        case 2010:
                            return color(treatiesById.get(d.id)[0].y2010.population);
                            break;
                        case 2011:
                            return color(treatiesById.get(d.id)[0].y2011.population);
                            break;
                        case 2012:
                            return color(treatiesById.get(d.id)[0].y2012.population);
                            break;
                        case 2013:
                            return color(treatiesById.get(d.id)[0].y2013.population);
                            break;
                        }
                    });

                svg.selectAll("image")
                    .attr("class", "purpose")
                    .attr("xlink:href", function (d) {
                        var purpose_percentage;
                        switch (year) {
                        case 2006:
                            purpose_percentage = [["vacation", d.y2006.vacation], ["visit_friends", d.y2006.visit_friends], ["business", d.y2006.business], ["education", d.y2006.education]];
                            break;
                        case 2007:
                            purpose_percentage = [["vacation", d.y2007.vacation], ["visit_friends", d.y2007.visit_friends], ["business", d.y2007.business], ["education", d.y2007.education]];
                            break;
                        case 2008:
                            purpose_percentage = [["vacation", d.y2008.vacation], ["visit_friends", d.y2008.visit_friends], ["business", d.y2008.business], ["education", d.y2008.education]];
                            break;
                        case 2009:
                            purpose_percentage = [["vacation", d.y2009.vacation], ["visit_friends", d.y2009.visit_friends], ["business", d.y2009.business], ["education", d.y2009.education]];
                            break
                        case 2010:
                            purpose_percentage = [["vacation", d.y2010.vacation], ["visit_friends", d.y2010.visit_friends], ["business", d.y2010.business], ["education", d.y2010.education]];
                            break;
                        case 2011:
                            purpose_percentage = [["vacation", d.y2011.vacation], ["visit_friends", d.y2011.visit_friends], ["business", d.y2011.business], ["education", d.y2011.education]];
                            break;
                        case 2012:
                            purpose_percentage = [["vacation", d.y2012.vacation], ["visit_friends", d.y2012.visit_friends], ["business", d.y2012.business], ["education", d.y2012.education]];
                            break;
                        case 2013:
                            purpose_percentage = [["vacation", d.y2013.vacation], ["visit_friends", d.y2013.visit_friends], ["business", d.y2013.business], ["education", d.y2013.education]];
                            break;
                        }
                        purpose_percentage.sort(function (a, b) {
                            return b[1] - a[1]
                        });
                        if (purpose_percentage[0][1] != null)
                            return flag[purpose_percentage[0][0]];
                        else return flag['unknown'];
                    });
                d3.select("#nRadius-value").text(year);
                d3.select("#nRadius").property("value", year);
            }

            $("#USExport").on("click", function () {
                $("#USExport").css("fill", "lightskyblue");
                $("#USExport").css("stroke", "black");
                $("#USExport").css("stroke-width", "1");
                queue()
                    .defer(d3.json, "world-50m.json")
                    .defer(d3.json, "outbound_json.json")
                    .await(drawExportVisualization);
            });
            $("#CountryGDP").on("click", function () {
                $("#CountryGDP").css("fill", "lightskyblue");
                $("#CountryGDP").css("stroke", "black");
                $("#CountryGDP").css("stroke-width", "1");
                queue()
                    .defer(d3.json, "world-50m.json")
                    .defer(d3.csv, "WORLD_GDP_DATA.csv")
                    .await(drawGDPVisualization);
            });

            function drawExportVisualization(error, world, exportdata) {

                svg.selectAll(".purpose").remove();
                var color = d3.scale.linear()
                    .domain([20, 10000, 100000])
                    .range(["#0ca454", "#ffa07a", "#de1f2e"])
                    .clamp(true)
                    .interpolate(d3.interpolateHcl);

                var populationById = d3.nest()
                    .key(function (d) {
                        return d.id;
                    })
                    .sortValues(function (a, b) {
                        return a.y2006 - b.y2006;
                    })
                    .map(exportdata, d3.map);

                var country = svg.insert("g", ".graticule")
                    .attr("class", "country")
                    .selectAll("path")
                    .data(topojson.feature(world, world.objects.countries).features)
                    .enter().append("path")
                    .attr("d", path);

                country.filter(function (d) {
                        return populationById.has(d.id);
                    })
                    .style("fill", function (d) {
                        if (populationById.get(d.id)[0].y2006 == null)
                            return "#cccccc";
                        else
                            return color(populationById.get(d.id)[0].y2006);

                    })
                    .on("mouseover", function (d) {
                        d3.select(this).transition().duration(300).style("opacity", 1);
                        div.transition().duration(300)
                            .style("opacity", 1)
                        div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2006)
                            .style("left", "65%")
                            .style("top", "400px");
                    })
                    .on("mouseout", function () {
                        d3.select(this)
                            .transition().duration(300)
                            .style("opacity", 1);
                        div.transition().duration(300)
                            .style("opacity", 0);
                    });

                d3.select("#nRadius").on("input", function () {
                    updateExportVis(exportdata, +this.value);
                });

                function updateExportVis(exportdata, year) {

                    d3.select("#nRadius-value").text(year);
                    d3.select("#nRadius").property("value", year);

                    country.filter(function (d) {
                            return populationById.has(d.id);
                        })
                        .style("fill", function (d) {
                            switch (year) {
                            case 2006:
                                if (!populationById.get(d.id)[0].y2006 || populationById.get(d.id)[0].y2006 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2006);
                                break;
                            case 2007:
                                if (!populationById.get(d.id)[0].y2007 || populationById.get(d.id)[0].y2007 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2007);
                                break;
                            case 2008:
                                if (!populationById.get(d.id)[0].y2008 || populationById.get(d.id)[0].y2008 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2008);
                                break;
                            case 2009:
                                if (!populationById.get(d.id)[0].y2009 || populationById.get(d.id)[0].y2009 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2009);
                                break;
                            case 2010:
                                if (!populationById.get(d.id)[0].y2010 || populationById.get(d.id)[0].y2010 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2010);
                                break;
                            case 2011:
                                if (!populationById.get(d.id)[0].y2011 || populationById.get(d.id)[0].y2011 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2011);
                                break;
                            case 2012:
                                if (!populationById.get(d.id)[0].y2012 || populationById.get(d.id)[0].y2012 == null) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2012);
                                break;
                            case 2013:
                                if (!populationById.get(d.id)[0].y2013) {
                                    return "#cccccc";
                                }
                                return color(populationById.get(d.id)[0].y2013);
                                break;
                            }
                        })
                        .on("mouseover", function (d) {
                            d3.select(this).transition().duration(300).style("opacity", 1);
                            div.transition().duration(300)
                                .style("opacity", 1)
                                .style("left", "65%")
                                .style("top", "400px");
                            switch (year) {
                            case 2006:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2006)
                                break;
                            case 2007:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2007)
                                break;
                            case 2008:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2008)
                                break;
                            case 2009:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2009)
                                break;
                            case 2010:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2010)
                                break;
                            case 2011:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2011)
                                break;
                            case 2012:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2012)
                                break;
                            case 2013:
                                div.html("<span style=color:#cc0000;font-size:20px>" + populationById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>Population</span>" + ":" + populationById.get(d.id)[0].y2013)
                                break;
                            }
                        })
                        .on("mouseout", function () {
                            d3.select(this)
                                .transition().duration(300)
                                .style("opacity", 1);
                            div.transition().duration(300)
                                .style("opacity", 0);
                        });
                }
            }

            function drawGDPVisualization(error, world, GDPdata) {
                svg.selectAll(".purpose").remove();
                var color = d3.scale.linear()
                    .domain([0, 10, 15, 20])
                    .range(["#0ca454", "#ffa07a", "#de1f2e"])
                    .clamp(true)
                    .interpolate(d3.interpolateHcl);

                var GDPById = d3.nest()
                    .key(function (d) {
                        return d.id;
                    })
                    .sortValues(function (a, b) {
                        return a.y2006 - b.y2006;
                    })
                    .map(GDPdata, d3.map);

                var country = svg.insert("g", ".graticule")
                    .attr("class", "country")
                    .selectAll("path")
                    .data(topojson.feature(world, world.objects.countries).features)
                    .enter().append("path")
                    .attr("d", path);

                country.filter(function (d) {
                        return GDPById.has(d.id);
                    })
                    .style("fill", function (d) {
                        if (!GDPById.get(d.id)[0].y2006) return "#cccccc";
                        return color(GDPById.get(d.id)[0].y2006);
                    })
                    .on("mouseover", function (d) {
                        d3.select(this).transition().duration(300).style("opacity", 1);
                        div.transition().duration(300)
                            .style("opacity", 1)
                        div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                "<br/>" + "<span style=color:#000>GDP</span>" + ":" + GDPById.get(d.id)[0].y2006 + "%")
                            .style("left", "65%")
                            .style("top", "400px");
                    })
                    .on("mouseout", function () {
                        d3.selectAll('.donut').remove();
                        d3.select(this)
                            .transition().duration(300)
                            .style("opacity", 1);
                        div.transition().duration(300)
                            .style("opacity", 0);
                    });

                d3.select("#nRadius").on("input", function () {
                    updateGDPVis(GDPdata, +this.value);
                });

                function updateGDPVis(GDPdata, year) {

                    d3.select("#nRadius-value").text(year);
                    d3.select("#nRadius").property("value", year);

                    country.filter(function (d) {
                            return GDPById.has(d.id);
                        })
                        .style("fill", function (d) {
                            switch (year) {
                            case 2006:
                                if (!GDPById.get(d.id)[0].y2006) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2006);
                                break;
                            case 2007:
                                if (!GDPById.get(d.id)[0].y2007) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2007);
                                break;
                            case 2008:
                                if (!GDPById.get(d.id)[0].y2008) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2008);
                                break;
                            case 2009:
                                if (!GDPById.get(d.id)[0].y2009) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2009);
                                break;
                            case 2010:
                                if (!GDPById.get(d.id)[0].y2010) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2010);
                                break;
                            case 2011:
                                if (!GDPById.get(d.id)[0].y2011) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2011);
                                break;
                            case 2012:
                                if (!GDPById.get(d.id)[0].y2012) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2012);
                                break;
                            case 2013:
                                if (!GDPById.get(d.id)[0].y2013) return "#cccccc";
                                return color(GDPById.get(d.id)[0].y2013);
                                break;
                            }
                        })
                        .on("mouseover", function (d) {
                            d3.select(this).transition().duration(300).style("opacity", 1);
                            div.transition().duration(300)
                                .style("opacity", 1)
                                .style("left", "65%")
                                .style("top", "400px");
                            switch (year) {
                            case 2006:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2006 + "%")
                                break;
                            case 2007:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2007 + "%")
                                break;
                            case 2008:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2008 + "%")
                                break;
                            case 2009:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2009 + "%")
                                break;
                            case 2010:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2010 + "%")
                                break;
                            case 2011:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2011 + "%")
                                break;
                            case 2012:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2012 + "%")
                                break;
                            case 2013:
                                div.html("<span style=color:#cc0000;font-size:20px>" + GDPById.get(d.id)[0].Country + "</span>" +
                                    "<br/>" + "<span style=color:#000>% of GDP</span>" + ":" + GDPById.get(d.id)[0].y2013 + "%")
                                break;
                            }
                        })
                        .on("mouseout", function () {
                            d3.select(this)
                                .transition().duration(300)
                                .style("opacity", 1);
                            div.transition().duration(300)
                                .style("opacity", 0);
                        });
                }
            }
        }
    </script>

</body>

</html>