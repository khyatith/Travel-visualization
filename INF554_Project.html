<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

.country {
  fill: #ccc;
  stroke: #fff;
  stroke-width: .5px;
  stroke-linejoin: round;
}

.graticule {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  stroke-width: .5px;
}

.graticule.outline {
  stroke: #333;
  stroke-opacity: 1;
  stroke-width: 1.5px;
}

</style>

</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 960,
    height = 500;

var projection = d3.geo.patterson(),
    color = d3.scale.category10(),
    graticule = d3.geo.graticule();

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

 var flag = {

                "vacation": 'resources/images/vacation.png',

                "visit_friends": 'resources/images/visit_friends.png',

                "business": 'resources/images/business.png',

                "education": 'resources/images/education.png',
                }


        d3.json("readme-world.json", function (error, world) {
            var countries = topojson.feature(world, world.objects.countries).features,
                neighbors = topojson.neighbors(world.objects.countries.geometries);

            svg.selectAll(".country")
                .data(countries)
                .enter().insert("path", ".graticule")
                .attr("class", "country")
                .attr("d", path)
                //.style("fill", function(d, i) { return color(d.color = d3.max(neighbors[i], function(n) { return countries[n].color; }) + 1 | 0); });

            d3.json("final_json.json", function (error, data) {
                svg.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) {
                        return projection([d.lon, d.lat])[0];
                    })
                    .attr("cy", function (d) {
                        return projection([d.lon, d.lat])[1];
                    })
                    .attr("r", function (d) {
                        return d.y2011.population / 100;
                    })
                    .style("fill", "red");
                //draw the purpose flag
                svg.selectAll("image")
                    .data(data)
                    .enter()
                    .append("image")
                    .attr("xlink:href", function(d) {
                    var purpose_percentage = [["vacation", d.y2011.vacation], ["visit friends", d.y2011["visit friends"]], ["business", d.y2011.business], ["education", d.y2011.education]];
                    purpose_percentage.sort(function(a, b){return b[1]-a[1]});
                    return flag[purpose_percentage[0][0]];
                })
                    .attr("x", function (d) {
                        return projection([d.lon, d.lat])[0]-11;
                    })
                    .attr("y", function (d) {
                        return projection([d.lon, d.lat])[1]-30;
                    })
                    .attr("width", "30")
                    .attr("height", "30");
            });
        });

</script>

    </body>
</html>