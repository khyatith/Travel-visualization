<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

.country {
  fill: #ccc;
  stroke: #fff;
  stroke-width: .5px;
  stroke-linejoin: round;
}

.graticule {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  stroke-width: .5px;
}

.graticule.outline {
  stroke: #333;
  stroke-opacity: 1;
  stroke-width: 1.5px;
}
#nRadius-value{
  font-size: 40px;
}
div.tooltip {
 position: absolute;
 text-align: center;
 width: 150px;
 height: 120px;
 padding: 2px;
 font-size: 15px;
 background: orange;
 border: 1px;
 border-radius : 4px;
 pointer-events: none;
 color:#cc0000;
}
</style>

</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<input type="range" min="2006" max="2013" step="1" id="nRadius">
<label for="nRadius" 
         style="display: inline-block; width: 240px; text-align: right">
         <span id="nRadius-value">â€¦</span>
  </label>
<script>
var color_domain = [500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000];
var ext_color_domain = [0, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000];
var color = d3.scale.threshold()
 .domain(color_domain)
 .range(["#dcdcdc", "#d0d6cd", "#bdc9be", "#aabdaf", "#97b0a0", "#84a491", "719782", "#5e8b73", "#4b7e64", "#387255", "#256546", "#125937", "#004d28"]);
var width = 960,
    height = 500;

var projection = d3.geo.patterson(),
    color = d3.scale.category10(),
    graticule = d3.geo.graticule();

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

 var flag = {

                "vacation": 'resources/images/vacation.png',

                "visit_friends": 'resources/images/visit_friends.png',

                "business": 'resources/images/business.png',

                "education": 'resources/images/education.png',
                }


        d3.json("readme-world.json", function (error, world) {
		
            var countries = topojson.feature(world, world.objects.countries).features,
                neighbors = topojson.neighbors(world.objects.countries.geometries);
            
	d3.json("final_json.json", function (error, data) {
	var name =[];
	var lat = [];
	var lon = [];
	var y2006 = [];
	for(var i =0;i<data.length;i++){
	name.push(data[i].name);
	lat.push(data[i].lat);
	lon.push(data[i].lon);
	y2006.push(data[i].y2006);
	}
	/*console.log(name);
	console.log(lat);
	console.log(lon);
	console.log(y2006);*/
	drawVisualization(data,name,lat,lon,2006);
	// when the input range changes update the circle 
	d3.select("#nRadius").on("input", function() {
	updatevis(+this.value);
	});
	});
			function drawVisualization(data,name,lat,lon,year){
				/*
				I think we can use this to color the regions , but I am not sure since it is not giving correct results ! :P
				*/
				/*var pairRateWithId = {};
				var pairLatWithId = {};
				var pairLonWithId = {};
 
				data.forEach(function(d) {
					pairRateWithId[d.name] = +d.y2006.population;
				});
				svg.selectAll(".country")
					.data(data)
					.style ( "fill" , function (d) {
						return color (pairRateWithId[d.y2006.population]);
				})
					.style("opacity", 0.8*/
	  
				svg.selectAll(".country")
                .data(countries)
                .enter().insert("path", ".graticule")
                .attr("class", "country")
                .attr("d", path);
					
                var div = d3.select("body").append("div")
							.attr("class", "tooltip")
							.style("opacity", 0);
				svg.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) {
                        return projection([d.lon, d.lat])[0];
                    })
                    .attr("cy", function (d) {
                        return projection([d.lon, d.lat])[1];
                    })
                    .attr("r", function(d,i){
							return d.y2006.population /100;
							})
                    .style("fill","red");
                //draw the purpose flag
                svg.selectAll("image")
                    .data(data)
                    .enter()
                    .append("image")
                    .attr("xlink:href", function(d) {
                    var purpose_percentage = [["vacation", d.y2006.vacation], ["visit friends", d.y2006["visit friends"]], ["business", d.y2006.business], ["education", d.y2006.education]];
					purpose_percentage.sort(function(a, b){return b[1]-a[1]});
                    return flag[purpose_percentage[0][0]];
                })
                    .attr("x", function (d) {
                        return projection([d.lon, d.lat])[0]-11;
                    })
                    .attr("y", function (d) {
                        return projection([d.lon, d.lat])[1]-30;
                    })
                    .attr("width", "30")
                    .attr("height", "30")
					.on("mouseover", function(d) {
							d3.select(this).transition().duration(300).style("opacity", 1);
							div.transition().duration(300)
							   .style("opacity", 1)
							div.html("<span style=color:#ffffff>Country</span>" + " : " + d.name + 
							"<br/>" + "<span style=color:#ffffff>Population</span>" + ":" + d.y2006.population + 
							"<br/>" + "<span style=color:#ffffff>Vacation</span>" + ":" + d.y2006.vacation +
							"<br/>" + "<span style=color:#ffffff>Visit Friends</span>" + ":" + d.y2006["visit friends"] +
							"<br/>" + "<span style=color:#ffffff>Business</span>" + ":" + d.y2006.business +
							"<br/>" + "<span style=color:#ffffff>Education</span>" + ":" + d.y2006.education)
							   .style("left", (d3.event.pageX) + "px")
							   .style("top", (d3.event.pageY -30) + "px");
                        })
							   .on("mouseout", function() {
                            d3.select(this)
                              .transition().duration(300)
                              .style("opacity", 0.8);
                            div.transition().duration(300)
                               .style("opacity", 0);
                        });
				d3.select("#nRadius-value").text("2006");
				d3.select("#nRadius").property("value", "2006");
            }
		function updatevis(year)
		{
			svg.selectAll("circle")
               .attr("r", function(d){
					switch(year){
					case 2006:
					return d.y2006.population /100;
					break;
					case 2007:
					return d.y2007.population /100;
					break;
					case 2008:
					return d.y2008.population /100;
					break;
					case 2009:
					return d.y2009.population /100;
					break;
					case 2010:
					return d.y2010.population /100;
					break;
					case 2011:
					return d.y2011.population /100;
					break;
					case 2012:
					return d.y2012.population /100;
					break;
					case 2013:
					return d.y2013.population /100;
					break;
				}
				})
               .style("fill","blue")
			   .style("opacity",0.5);
			
			svg.selectAll("image")
			   .attr("xlink:href", function(d) {
					var purpose_percentage;
					switch(year){
					case 2006:
					purpose_percentage = [["vacation", d.y2006.vacation], ["visit friends", d.y2006["visit friends"]], ["business", d.y2006.business], ["education", d.y2006.education]];
					break;
					case 2007:
					purpose_percentage = [["vacation", d.y2007.vacation], ["visit friends", d.y2007["visit friends"]], ["business", d.y2007.business], ["education", d.y2007.education]];
					break;
					case 2008:
					purpose_percentage = [["vacation", d.y2008.vacation], ["visit friends", d.y2008["visit friends"]], ["business", d.y2008.business], ["education", d.y2008.education]];
					break;
					case 2009:
					purpose_percentage = [["vacation", d.y2009.vacation], ["visit friends", d.y2009["visit friends"]], ["business", d.y2009.business], ["education", d.y2009.education]];
					break
					case 2010:
					purpose_percentage = [["vacation", d.y2010.vacation], ["visit friends", d.y2010["visit friends"]], ["business", d.y2010.business], ["education", d.y2010.education]];
					break;
					case 2011:
					purpose_percentage = [["vacation", d.y2011.vacation], ["visit friends", d.y2011["visit friends"]], ["business", d.y2011.business], ["education", d.y2011.education]];
					break;
					case 2012:
					purpose_percentage = [["vacation", d.y2012.vacation], ["visit friends", d.y2012["visit friends"]], ["business", d.y2012.business], ["education", d.y2012.education]];
					break;
					case 2013:
					purpose_percentage = [["vacation", d.y2013.vacation], ["visit friends", d.y2013["visit friends"]], ["business", d.y2013.business], ["education", d.y2013.education]];
					break;
					}
					purpose_percentage.sort(function(a, b){return b[1]-a[1]});
                    return flag[purpose_percentage[0][0]];
                });
			d3.select("#nRadius-value").text(year);
			d3.select("#nRadius").property("value", year);
		}
});
</script>

    </body>
</html>